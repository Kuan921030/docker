# image based on ros2 humble base
FROM ros:humble-ros-base-jammy

# docker specific tweaks, see
# https://github.com/docker/docker/blob/9a9fc01af8fb5d98b8eec0740716226fadb3735c/contrib/mkimage/debootstrap#L85-L105
RUN echo 'DPkg::Post-Invoke { "rm -f /var/cache/apt/archives/*.deb /var/cache/apt/archives/partial/*.deb /var/cache/apt/*.bin || true"; };' > /etc/apt/apt.conf.d/docker-clean \
    && echo 'APT::Update::Post-Invoke { "rm -f /var/cache/apt/archives/*.deb /var/cache/apt/archives/partial/*.deb /var/cache/apt/*.bin || true"; };' >> /etc/apt/apt.conf.d/docker-clean \
    && echo 'Dir::Cache::pkgcache ""; Dir::Cache::srcpkgcache "";' >> /etc/apt/apt.conf.d/docker-clean

# update package repository information and install with no prompt
# bash-completion -> bash auto-complete
# htop -> system monitor
# tmux -> terminal multiplexer
# vim -> command line text editor
RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install --no-install-recommends -y \
    bash-completion \
    htop \
    tmux \
    vim \
    && apt-get clean && apt-get autoremove

# install wiringPi
RUN git clone https://github.com/WiringPi/WiringPi.git \
    && cd WiringPi \
    && ./build \
    && cd .. \
    && rm -rf WiringPi

# switch to root home directory
ENV USER root
WORKDIR /root

# clone nturt_ros and install dependencies
RUN mkdir -p ~/ws/src \
    && cd ~/ws/src \
    && git clone https://github.com/NTURacingTeam/nturt_ros.git --recurse-submodules \
    && git clone https://github.com/NTURacingTeam/nturt_test.git --recurse-submodules \
    && cd ~/ws \
    && rosdep install --from-paths src --ignore-src -r -y

# build, using bash warpper for avoiding wierd problems
RUN bash -c 'source /opt/ros/humble/setup.bash && cd ~/ws && colcon build --symlink-install'

COPY ./ros2_rpi_deploy .

CMD ["./ros2_rpi_deploy"]
